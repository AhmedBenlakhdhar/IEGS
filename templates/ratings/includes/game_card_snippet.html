{# templates/ratings/includes/game_card_snippet.html #}
{% load static %}
{% load i18n %}

<a href="{{ game.get_absolute_url }}" class="card-link-wrapper">
  <div class="card game-card h-100">
    {% if game.cover_image_url %}
      <img src="{{ game.cover_image_url }}" class="card-img-top" alt="{% blocktranslate %}{{ game.title }} Cover{% endblocktranslate %}">
    {% else %}
      <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 180px;">
        <span>{% translate "No Image" %}</span>
      </div>
    {% endif %}

    <div class="card-body d-flex flex-column">
      <h4 class="card-title">{{ game.title }}</h4>

      {# --- START: Platform Icons --- #}
      <div class="platform-icons-container mb-2">
          {% if game.available_pc %}
              <span class="platform-icon platform-pc" title="{% translate 'PC' %}"><i class="fa-brands fa-windows"></i></span>
          {% endif %}
          {% if game.available_ps5 %}
               <span class="platform-icon platform-ps" title="{% translate 'PlayStation 5' %}"><i class="fa-brands fa-playstation"></i></span>
          {% elif game.available_ps4 %} {# Show generic PS icon if only PS4 #}
               <span class="platform-icon platform-ps" title="{% translate 'PlayStation 4' %}"><i class="fa-brands fa-playstation"></i></span>
          {% endif %}
          {% if game.available_xbox_series %}
              <span class="platform-icon platform-xbox" title="{% translate 'Xbox Series X|S' %}"><i class="fa-brands fa-xbox"></i></span>
           {% elif game.available_xbox_one %} {# Show generic Xbox icon if only Xbox One #}
               <span class="platform-icon platform-xbox" title="{% translate 'Xbox One' %}"><i class="fa-brands fa-xbox"></i></span>
          {% endif %}
          {% if game.available_switch %}
              {# Font Awesome doesn't have a direct Switch icon, use a generic gamepad or mobile icon #}
               <span class="platform-icon platform-switch" title="{% translate 'Nintendo Switch' %}"><img src="{% static 'img/nintendo-switch.svg' %}" alt="{% translate 'Nintendo Switch' %}"></span>
          {% endif %}
          {% if game.available_android %}
              <span class="platform-icon platform-android" title="{% translate 'Android' %}"><i class="fa-brands fa-android"></i></span>
          {% endif %}
          {% if game.available_ios %}
              <span class="platform-icon platform-ios" title="{% translate 'iOS' %}"><i class="fa-brands fa-apple"></i></span>
          {% endif %}
          {% if game.available_meta_quest %}
              <span class="platform-icon platform-meta-quest" title="{% translate 'Meta Quest' %}"><i class="fa-brands fa-meta"></i></span>
          {% endif %}
          {# Add message if no platforms are checked #}
          {% if not game.available_pc and not game.available_ps5 and not game.available_ps4 and not game.available_xbox_series and not game.available_xbox_one and not game.available_switch %}
               <span class="text-secondary small fst-italic">{% translate "Platforms not specified" %}</span>
          {% endif %}
      </div>
      {# --- END: Platform Icons --- #}

     <div class="rating-flags-container mt-auto pt-2">
        {# Determine which tier to display as the MAIN badge #}
        {% with main_tier=game.original_rating_tier|default:game.rating_tier %}
            {# If original_rating_tier is None (e.g., not adjustable, or data missing), it defaults to the final rating_tier #}
            <span class="rating-badge rating-{{ main_tier.tier_code }}"
                  style="background-color: var(--rating-{{ main_tier.tier_code }});">
                <span class="material-symbols-outlined rating-icon">{{ main_tier.icon_name }}</span>
                <span class="rating-label">
                  {% comment %} Translate the displayed tier name {% endcomment %}
                  {% if main_tier.display_name == "Haram" %}{{ translated_haram }}
                  {% elif main_tier.display_name == "Mashbouh" %}{{ translated_mashbouh }}
                  {% elif main_tier.display_name == "Halal" %}{{ translated_halal }}
                  {% elif main_tier.display_name == "Kufr" %}{{ translated_kufr }}
                  {% else %}{{ main_tier.display_name }}
                  {% endif %}
                </span>
            </span>
        {% endwith %}
        
        {% if game.requires_adjustment and game.original_rating_tier and game.rating_tier.tier_code != game.original_rating_tier.tier_code %}
          {% with final_code=game.rating_tier.tier_code %}
              <span class="adjustment-badge-bordered adjustable-border-{{ final_code|lower }}"
                    title="{% blocktranslate %}Adjustable (Achieves {{ game.rating_tier.display_name }}){% endblocktranslate %}">
                    {% translate "Adjustable" %}
              </span>
          {% endwith %}
        {% endif %}
        
        <br class="mt-1">
          {% for flag in game.flags.all %}
              {% if game.requires_adjustment and flag in game.adjustable_flags.all %}
                  <span class="flag-symbol material-symbols-outlined flag-adjustable"
                        title="{{ flag.description }} ({% translate 'Can be adjusted/avoided' %})">
                        {{ flag.symbol }}</span>
              {% else %}
                  <span class="flag-symbol material-symbols-outlined"
                        title="{{ flag.description }}">
                        {{ flag.symbol }}</span>
              {% endif %}
          {% empty %}
          <div class="no-flags-message"><small class="text-secondary">{% translate "No specific content flags noted." %}</small></div>
          {% endfor %}
      </div>
    </div>
  </div>
</a>
