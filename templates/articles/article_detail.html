{# templates/articles/article_detail.html - UPDATED #}
{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %} {# Load widget_tweaks #}

{% block title %}{{ article.title }} - {% translate "MGC Article" %}{% endblock %}

{% block content %}
  <article class="article-detail-wrapper mb-4">

      {# ... (Existing Article Header/Meta/Content code) ... #}
       <h1 class="article-detail-title">{{ article.title }}</h1>
       <p class="article-detail-meta mb-1"> {# Reduced bottom margin #}
           {% translate "Published:" %} {{ article.published_date|date:"F j, Y" }}
           {% if article.author_name %} | {% translate "By:" %} {{ article.author_name }}{% endif %}
       </p>
       {% if article.categories.exists %}
           <p class="article-categories small text-secondary mb-3">
               {% translate "Categories:" %}
               {% for cat in article.categories.all %}
                   <a href="{{ cat.get_absolute_url }}" class="badge bg-secondary text-decoration-none link-light me-1">{{ cat.name }}</a>
               {% endfor %}
           </p>
       {% endif %}
       <div class="article-content">
           {{ article.content|safe }}
       </div>
       {# ... (Existing back link code) ... #}
        <a href="{% url 'articles:article_list' %}" class="back-link mt-4">{% translate "‚Üê Back to Articles" %}</a>

  </article>

  {# --- START: Comments Section --- #}
  <section class="comments-section mt-5 pt-4 border-top" id="comments-section">
       <h3 class="mb-4 guide-section-title" style="text-align: inherit; font-size: 1.3rem;">
           {# Count only approved comments for the title #}
           {% with approved_comment_list=all_comments|dictsort:"approved"|slice:":-1" %}
               {% blocktranslate count comment_count=approved_comment_list|length %}{{ approved_comment_list|length }} Comment{% plural %}{{ approved_comment_list|length }} Comments{% endblocktranslate %}
           {% endwith %}
       </h3>

       {% for comment in all_comments %}
           {# Display logic: Show if approved OR if the current user is staff #}
           {% if comment.approved or user.is_staff %}
               <div class="comment mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %} {% if not comment.approved %}comment-unapproved{% endif %}">
                   <div class="comment-header d-flex justify-content-between align-items-center flex-wrap">
                       <div>
                           <span class="comment-author fw-bold">{{ comment.user.username }}</span>
                           <small class="comment-date text-secondary ms-2">{{ comment.created_date|timesince }} {% translate "ago" %}</small>
                           {# Staff-only status indicators #}
                           {% if not comment.approved and user.is_staff %}<span class="badge bg-warning text-dark ms-2">{% translate "Pending Approval" %}</span>{% endif %}
                           {% if comment.moderator_attention_needed and user.is_staff %}<span class="badge bg-danger ms-2" title="{% blocktranslate count flag_count=comment.flag_count %}{{ flag_count }} flag{% plural %}{{ flag_count }} flags{% endblocktranslate %}"><i class="fa-solid fa-flag me-1"></i> {% translate "Needs Review" %}</span>{% elif comment.moderator_attention_needed %}<span class="badge bg-secondary ms-2" title="{% translate 'Flagged for review' %}"><i class="fa-solid fa-flag"></i></span>{% endif %}
                       </div>
                       <div class="comment-actions mt-1 mt-sm-0">
                           {# Flag Button (Only if logged in, not comment author, and not already flagged by this user) #}
                           {% if user.is_authenticated and user != comment.user %}
                               {% if user in comment.flagged_by.all %}
                                   <span class="text-secondary small me-2"><i class="fa-solid fa-flag"></i> {% translate "Flagged" %}</span>
                               {% else %}
                                   <form action="{% url 'articles:flag_article_comment' comment.id %}" method="post" style="display: inline;">
                                       {% csrf_token %}
                                       <button type="submit" class="btn btn-sm btn-outline-warning comment-action-btn" title="{% translate 'Flag this comment for review' %}">
                                           <i class="fa-regular fa-flag"></i> <span class="d-none d-md-inline">{% translate "Flag" %}</span>
                                       </button>
                                   </form>
                               {% endif %}
                           {% endif %}

                           {# Delete Button (Only for staff) #}
                           {% if user.is_staff %}
                               <form action="{% url 'articles:delete_article_comment' comment.id %}" method="post" style="display: inline;" onsubmit="return confirm('{% translate "Are you sure you want to delete this comment?" %}');">
                                   {% csrf_token %}
                                   <button type="submit" class="btn btn-sm btn-outline-danger comment-action-btn" title="{% translate 'Delete this comment' %}">
                                       <i class="fa-regular fa-trash-can"></i> <span class="d-none d-md-inline">{% translate "Delete" %}</span>
                                   </button>
                               </form>
                           {% endif %}
                       </div>
                   </div>
                   {# Comment Body (only visible if approved or user is staff) #}
                   <div class="comment-body mt-2 {% if not comment.approved and not user.is_staff %}d-none{% endif %}">
                       {{ comment.content|linebreaksbr }}
                   </div>
               </div>
           {% endif %}
       {% empty %}
           <p class="text-secondary">{% translate "No comments yet. Be the first to comment!" %}</p>
       {% endfor %}

       {# --- Comment Form --- #}
       {% if user.is_authenticated %}
           <div class="comment-form-container mt-4 pt-4 border-top" id="comment-form"> {# Added anchor ID #}
               <h4 class="mb-3">{% translate "Add Your Comment" %}</h4>
                {% if messages %}
                    {% for message in messages %}
                        {# Filter messages specifically tagged for comment errors/success #}
                        {% if 'comment_error' in message.tags or message.level == 40 %}
                            <div class="alert alert-danger" role="alert">{{ message }}</div>
                        {% elif 'comment_success' in message.tags %}
                             <div class="alert alert-success" role="alert">{{ message }}</div>
                         {% elif 'comment_warning' in message.tags %}
                             <div class="alert alert-warning" role="alert">{{ message }}</div>
                         {% endif %}
                    {% endfor %}
                {% endif %}
               <form method="post" action="{{ request.path }}#comment-form"> {# Post to the current page with anchor #}
                   {% csrf_token %}
                   <div class="mb-3">
                       {# Use widget_tweaks to render content field #}
                       {% render_field comment_form.content class+="form-control" rows="3" placeholder=comment_form.content.field.widget.attrs.placeholder %}
                       {% if comment_form.content.errors %}
                           <div class="form-text text-danger">{{ comment_form.content.errors|striptags }}</div>
                       {% endif %}
                   </div>
                    {# Render reCAPTCHA field using widget_tweaks #}
                    <div class="mb-3">
                        {% render_field comment_form.captcha %}
                        {% if comment_form.captcha.errors %}
                            <div class="form-text text-danger">{{ comment_form.captcha.errors|striptags }}</div>
                        {% endif %}
                    </div>
                   <button type="submit" class="btn btn-primary btn-sm">{% translate "Submit Comment" %}</button>
               </form>
               {# Removed "awaiting approval" message since we auto-approve #}
           </div>
       {% else %}
           <p class="mt-4 pt-4 border-top">
              {% url 'login' as login_url %}
              {% blocktranslate %}Please <a href="{{ login_url }}?next={{ request.path }}" class="text-primary">login</a> to post a comment.{% endblocktranslate %}
           </p>
       {% endif %}
  </section>
  {# --- END: Comments Section --- #}

{% endblock %}